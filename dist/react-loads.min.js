!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports,require("react"),require("prop-types")):"function"==typeof define&&define.amd?define(["exports","react","prop-types"],r):r((e=e||self).ReactLoads={},e.React,e.PropTypes)}(this,function(e,r,t){"use strict";function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function o(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function c(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{},n=Object.keys(t);"function"==typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(t).filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.forEach(function(r){o(e,r,t[r])})}return e}function i(e,r){if(null==e)return{};var t,n,o=function(e,r){if(null==e)return{};var t,n,o={},c=Object.keys(e);for(n=0;n<c.length;n++)t=c[n],r.indexOf(t)>=0||(o[t]=e[t]);return o}(e,r);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);for(n=0;n<c.length;n++)t=c[n],r.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(o[t]=e[t])}return o}function a(e,r){return function(e){if(Array.isArray(e))return e}(e)||function(e,r){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var t=[],n=!0,o=!1,c=void 0;try{for(var i,a=e[Symbol.iterator]();!(n=(i=a.next()).done)&&(t.push(i.value),!r||t.length!==r);n=!0);}catch(e){o=!0,c=e}finally{try{n||null==a.return||a.return()}finally{if(o)throw c}}return t}(e,r)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function u(e){return function(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function s(){var e=r.useRef(void 0),t=r.useCallback(function(r,t){e.current=setTimeout(r,t)},[]),n=r.useCallback(function(){return clearTimeout(e.current)},[]);return r.useEffect(function(){return function(){e&&clearTimeout(e.current)}},[]),[t,n]}var f={CACHE_FIRST:"cache-first",CACHE_AND_LOAD:"cache-and-load",LOAD_ONLY:"load-only"},l={IDLE:"idle",PENDING:"pending",TIMEOUT:"timeout",RESOLVED:"resolved",REJECTED:"rejected"};function d(e){return function(r,t){var n=r.children,o=r.or;if(e)return"function"==typeof n?n(t):n;if(o){var c=o;return Array.isArray(o)||(c=[o]),0===c.length?null:(c=u(c)).shift()({children:n,or:c})}return null}}var p=r.createContext({cache:{records:{},get:function(){},set:function(){},reset:function(){}}});function v(e){var t=e.children,n=e.cacheProvider,i=a(r.useState({}),2),u=i[0],s=i[1],f=r.useCallback(function(e){s({});var r=e&&e.cacheProvider?e.cacheProvider:n;r&&r.reset()},[n]),l=r.useCallback(function(e,r,t){s(function(t){return c({},t,o({},e,r))});var i=t&&t.cacheProvider?t.cacheProvider:n;i&&i.set(e,r)},[n]),d=r.useCallback(function(e,r){var t=u[e];if(t)return t;var o=r&&r.cacheProvider?r.cacheProvider:n;if(o){var c=o.get(e);if(c)return c}},[n,u]),v=r.useMemo(function(){return{cache:{records:u,get:d,set:l,reset:f}}},[d,u,f,l]);return r.createElement(p.Provider,{value:v},t)}var E=c({},p,{Provider:v});function y(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=t.cacheProvider,v=t.delay,E=void 0===v?0:v,y=t.enableBackgroundStates,h=void 0!==y&&y,m=t.defer,b=void 0!==m&&m,O=t.loadPolicy,C=void 0===O?f.CACHE_AND_LOAD:O,R=t.throwError,D=void 0!==R&&R,g=t.timeout,P=void 0===g?0:g,T=t.update,L=Array.isArray(t.id)?t.id.join("."):t.id,A=t.id?"".concat(t.context,".").concat(L):t.context,I=r.useContext(p),S=r.useRef(0),j=function(){var e=r.useRef(!0);return r.useEffect(function(){return function(){e.current=!1}},[]),e}(),N=a(s(),2),w=N[0],x=N[1],_=a(s(),2),k=_[0],M=_[1];var J=r.useMemo(function(){if(A)return I.cache.get(A,{cacheProvider:i})},[i,A,I.cache]),V={state:l.IDLE};J&&!b&&C!==f.LOAD_ONLY&&(V=J);var B=a(r.useReducer(function(e,r){switch(r.type){case l.IDLE:return{state:l.IDLE};case l.PENDING:return c({},e,{state:l.PENDING});case l.TIMEOUT:return c({},e,{state:l.TIMEOUT});case l.RESOLVED:return{isCached:r.isCached,error:void 0,response:r.response,state:l.RESOLVED};case l.REJECTED:return{isCached:r.isCached,error:r.error,response:void 0,state:l.REJECTED};default:return e}},V),2),G=B[0],U=B[1];function q(e,r,t){if(j.current&&t===S.current&&(x(),M(),U({type:r,isCached:Boolean(A),error:r===l.REJECTED?e.error:void 0,response:r===l.RESOLVED?e.response:void 0}),A)){var n={error:e.error,response:e.response,state:r};I.cache.set(A,n,{cacheProvider:i})}}function H(e,r,t){var o,a=e.data,u=e.optsOrCallback,s=e.callback,f=a,d={};("object"===n(u)&&(d=u),"function"==typeof a)&&(G.response?o=G.response:d.context&&(o=I.cache.get(d.context,{cacheProvider:i})||{}),f=a(o));var p={error:r===l.REJECTED?f:void 0,response:r===l.RESOLVED?f:void 0};d.context&&A!==d.context?I.cache&&I.cache.set(d.context,c({},p,{state:r}),{cacheProvider:i}):q(p,r,t);var v="function"==typeof u?u:s;v&&v(f)}function Y(r){return function(){for(var n=arguments.length,o=new Array(n),i=0;i<n;i++)o[i]=arguments[i];var a=o.filter(function(e){return"Class"!==e.constructor.name});!t.args||a&&0!==a.length||(a=t.args),S.current=S.current+1;var s=S.current;if(!A||C===f.LOAD_ONLY||!J||(U(c({type:J.state,isCached:!0},J)),C!==f.CACHE_FIRST))return E>0?w(function(){return U({type:l.PENDING})},E):U({type:l.PENDING}),P>0&&k(function(){return U({type:l.TIMEOUT})},P),(r&&r.fn?r.fn:e).apply(void 0,u(a).concat([{cachedRecord:J,setResponse:function(e,r,t){return H({data:e,optsOrCallback:r,callback:t},l.RESOLVED,s)},setError:function(e,r,t){return H({data:e,optsOrCallback:r,callback:t},l.REJECTED,s)}}])).then(function(e){return q({response:e},l.RESOLVED,s),e}).catch(function(e){if(q({error:e},l.REJECTED,s),D)throw e})}}var F=r.useMemo(function(){if(T)return Array.isArray(T)?T.map(function(e){return Y({fn:e})}):Y({fn:T})},[T]),z=r.useCallback(function(){U({type:l.IDLE})},[]);r.useEffect(function(){!J&&A&&z()},[J,A]),r.useEffect(function(){J&&C!==f.LOAD_ONLY&&U(c({type:J.state,isCached:!0},J))},[J,C,U]),r.useEffect(function(){b||Y()()},[b,A,o?void 0:e].concat(u(o)));var K={isIdle:G.state===l.IDLE&&Boolean(!G.response||h),isPending:G.state===l.PENDING&&Boolean(!G.response||h),isTimeout:G.state===l.TIMEOUT&&Boolean(!G.response||h),isResolved:G.state===l.RESOLVED||Boolean(G.response),isRejected:G.state===l.REJECTED};return r.useMemo(function(){return c({load:Y(),update:F,reset:z,response:G.response,error:G.error,state:G.state},K,{Idle:d(K.isIdle),Pending:d(K.isPending),Timeout:d(K.isTimeout),Resolved:d(K.isResolved),Rejected:d(K.isRejected),isCached:Boolean(G.isCached)})},[G.response,G.error,G.state,G.isCached,K,F])}var h=r.createContext({isIdle:!1,isPending:!1,isTimeout:!1,isResolved:!1,isRejected:!1}),m=function(e){var t=e.children,n=e.load,o=e.inputs,c=y(n,i(e,["children","load","inputs"]),o||[]);return r.createElement(h.Provider,{value:c},"function"==typeof t?t(c):t)};m.propTypes={children:t.func.isRequired,load:t.func.isRequired,inputs:t.array},m.defaultProps={inputs:[]},m.Idle=function(e){return r.createElement(h.Consumer,null,function(r){return d(r.isIdle)(e,r)})},m.Pending=function(e){return r.createElement(h.Consumer,null,function(r){return d(r.isPending)(e,r)})},m.Timeout=function(e){return r.createElement(h.Consumer,null,function(r){return d(r.isTimeout)(e,r)})},m.Resolved=function(e){return r.createElement(h.Consumer,null,function(r){return d(r.isResolved)(e,r)})},m.Rejected=function(e){return r.createElement(h.Consumer,null,function(r){return d(r.isRejected)(e,r)})};var b=l,O=new Map;function C(e){var r=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).preload,t=void 0!==r&&r,n=e.load;return Array.isArray(e.load)&&(n=e.load[0]),function(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},o=r.id,c=r.args,i=void 0===c?[]:c,a=e._namespace;o&&(a="".concat(a,".").concat(o));var s=O.get(a);if("function"!=typeof n)throw new Error("TODO");var f=n.apply(void 0,u(i));if(void 0===s&&(s={state:b.PENDING,promise:f},O.set(a,s)),f.then(function(e){s={state:b.RESOLVED,response:e},O.set(a,s)}).catch(function(e){s={state:b.REJECTED,error:e},O.set(a,s)}),!t){if(s.state===b.PENDING)throw s.promise;if(s.state===b.RESOLVED&&s.response)return s.response;if(s.state===b.REJECTED)throw s.error}}}function R(e,r,t){return function(n,o){return y(e,c({context:t._namespace},r,n),o)}}e.Loads=m,e.LoadsContext=E,e.Provider=v,e.useLoads=y,e.useLoadsCache=function(e){return r.useContext(p).cache.get(e)},e.createResource=function(e){return c({},function(e){return Object.entries(e).reduce(function(r,t){var n=a(t,2),i=n[0],u=n[1];if("_"===i[0]||"string"==typeof u)return r;var s=u,f={};return Array.isArray(u)&&(s=u[0],f=u[1]||{}),"load"===i?c({},r,{useLoads:R(s,f,e)}):(f=c({},f,{enableBackgroundStates:!0}),c({},r,o({},i,{useLoads:R(s,f,e)})))},{})}(e),{unstable_load:C(e),unstable_preload:C(e,{preload:!0})})},Object.defineProperty(e,"__esModule",{value:!0})});
